// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  password          String?  // Nullable for Google OAuth users
  role              Role     @default(WORKER)
  isEmailConfirmed  Boolean  @default(false)
  confirmationToken String?  @unique
  googleId          String?  @unique
  firstName         String?
  lastName          String?
  avatar            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  createdCompanies Company[] @relation("CompanyCreator")
  workerProfiles   Worker[]
  createdProjects  Project[] @relation("ProjectCreator")
  assignedTasks    Task[]    @relation("TaskAssignee")
  createdTasks     Task[]    @relation("TaskCreator")
  createdMaterials Material[] @relation("MaterialCreator")
  
  // ETAP 8 - Jobs & Requests Relations
  createdJobOffers    JobOffer[]     @relation("JobOfferCreator")
  jobApplications     JobApplication[]
  createdWorkRequests WorkRequest[]  @relation("WorkRequestCreator")
  sentMessages        Message[]      @relation("MessageSender")
  receivedMessages    Message[]      @relation("MessageReceiver")
  
  // ETAP 10 - Subscription relation
  subscription        Subscription?
  
  // ETAP 11 - Notifications relation
  notifications       Notification[]
  
  // ETAP 15 - Analytics relations
  analytics           Analytics[]
  reports             Report[]
  searchHistory       SearchHistory[]
  savedSearches       SavedSearch[]
  jobViews            JobView[]

  @@map("users")
}

model Company {
  id          String   @id @default(cuid())
  name        String
  nip         String?  @unique
  address     String?
  latitude    Float?   // współrzędne GPS
  longitude   Float?
  phone       String?
  email       String?
  website     String?
  logo        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy   User      @relation("CompanyCreator", fields: [createdById], references: [id])
  createdById String
  workers     Worker[]
  projects    Project[]
  materials   Material[]
  
  // ETAP 8 - Jobs & Requests Relations
  jobOffers    JobOffer[]
  workRequests WorkRequest[]
  
  // ETAP 15 - Analytics relations
  analytics    Analytics[]
  reports      Report[]
  tags         Tag[]

  @@map("companies")
}

model Worker {
  id        String       @id @default(cuid())
  status    WorkerStatus @default(INVITED)
  invitedAt DateTime     @default(now())
  joinedAt  DateTime?
  leftAt    DateTime?
  position  String?
  
  // Permissions
  canEdit          Boolean @default(false)
  canView          Boolean @default(true)
  canManageFinance Boolean @default(false)

  // Relations
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  @@unique([userId, companyId])
  @@map("workers")
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  priority    Priority      @default(MEDIUM)
  startDate   DateTime?
  endDate     DateTime?
  deadline    DateTime?
  budget      Float?
  location    String?
  clientName  String?
  clientEmail String?
  clientPhone String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId   String
  createdBy   User    @relation("ProjectCreator", fields: [createdById], references: [id])
  createdById String
  tasks       Task[]
  materials   Material[]
  
  // ETAP 15 - Tags relation
  tags        Tag[]

  @@map("projects")
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  startDate   DateTime?
  dueDate     DateTime?
  estimatedHours Float?
  actualHours    Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  assignedTo  User?   @relation("TaskAssignee", fields: [assignedToId], references: [id])
  assignedToId String?
  createdBy   User    @relation("TaskCreator", fields: [createdById], references: [id])
  createdById String
  
  // ETAP 15 - Tags relation
  tags        Tag[]

  @@map("tasks")
}

model Material {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?  // np. "Cement", "Drewno", "Narzędzia"
  unit        String   @default("szt") // jednostka miary: szt, kg, m, m2, m3, l
  quantity    Float    @default(0)
  minQuantity Float?   // próg alertu o niskim stanie
  price       Float?   // cena za jednostkę
  supplier    String?  // dostawca
  location    String?  // lokalizacja w magazynie
  barcode     String?  // kod kreskowy
  notes       String?  // dodatkowe notatki
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId   String
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId   String?  // opcjonalne przypisanie do projektu
  createdBy   User     @relation("MaterialCreator", fields: [createdById], references: [id])
  createdById String
  
  // ETAP 15 - Tags relation
  tags        Tag[]

  @@map("materials")
}

// ETAP 8 - JOBS & WORK REQUESTS MODELS

model JobOffer {
  id          String      @id @default(cuid())
  title       String
  description String
  category    JobCategory
  type        JobType     @default(FULL_TIME)
  
  // Location
  country     String      @default("Polska")
  voivodeship String      // województwo
  city        String
  address     String?     // dokładny adres (opcjonalny)
  latitude    Float?      // współrzędne do mapy
  longitude   Float?
  
  // Job details
  salaryMin   Float?      // minimalne wynagrodzenie
  salaryMax   Float?      // maksymalne wynagrodzenie
  currency    String      @default("PLN")
  experience  ExperienceLevel @default(JUNIOR)
  
  // Requirements
  requirements String?    // wymagania (markdown)
  benefits     String?    // benefity (markdown)
  
  // Contact & Status
  contactEmail String?
  contactPhone String?
  isActive     Boolean    @default(true)
  isPublic     Boolean    @default(true) // czy widoczne publicznie
  expiresAt    DateTime?  // data wygaśnięcia
  
  // Analytics
  viewCount    Int        @default(0) // liczba wyświetleń ogłoszenia
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  company      Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId    String
  createdBy    User            @relation("JobOfferCreator", fields: [createdById], references: [id])
  createdById  String
  applications JobApplication[]
  messages     Message[]
  views        JobView[]       // views tracking

  @@map("job_offers")
}

// Model do śledzenia unikalnych wyświetleń ogłoszeń
model JobView {
  id        String   @id @default(cuid())
  ipAddress String   // adres IP użytkownika
  userAgent String?  // user agent przeglądarki
  sessionId String?  // ID sesji (jeśli dostępne)
  userId    String?  // ID użytkownika (jeśli zalogowany)
  viewedAt  DateTime @default(now())

  // Relations
  jobOffer   JobOffer @relation(fields: [jobOfferId], references: [id], onDelete: Cascade)
  jobOfferId String
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Unikalność: jedno IP może być liczone raz na 24h dla danego ogłoszenia
  @@unique([jobOfferId, ipAddress])
  @@map("job_views")
}

model JobApplication {
  id          String              @id @default(cuid())
  message     String?             // wiadomość od kandydata
  cvUrl       String?             // link do CV
  status      ApplicationStatus   @default(PENDING)
  appliedAt   DateTime            @default(now())
  reviewedAt  DateTime?
  notes       String?             // notatki rekrutera

  // Relations
  jobOffer    JobOffer @relation(fields: [jobOfferId], references: [id], onDelete: Cascade)
  jobOfferId  String
  applicant   User     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  applicantId String

  @@unique([jobOfferId, applicantId]) // jeden user może aplikować tylko raz na jedno ogłoszenie
  @@map("job_applications")
}

model WorkRequest {
  id          String         @id @default(cuid())
  title       String
  description String
  category    WorkCategory
  type        RequestType    @default(ONE_TIME)
  
  // Location
  country     String         @default("Polska")
  voivodeship String         // województwo
  city        String
  address     String?        // dokładny adres (opcjonalny)
  latitude    Float?         // współrzędne do mapy
  longitude   Float?
  
  // Budget & Timeline
  budgetMin   Float?         // minimalny budżet
  budgetMax   Float?         // maksymalny budżet
  currency    String         @default("PLN")
  deadline    DateTime?      // termin wykonania
  
  // Requirements
  requirements String?       // wymagania (markdown)
  materials    String?       // materiały (markdown)
  
  // Contact & Status
  contactEmail String?
  contactPhone String?
  isActive     Boolean       @default(true)
  isPublic     Boolean       @default(true) // czy widoczne publicznie
  expiresAt    DateTime?     // data wygaśnięcia
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyId    String?       // opcjonalne - może być prywatne zlecenie
  createdBy    User          @relation("WorkRequestCreator", fields: [createdById], references: [id])
  createdById  String
  messages     Message[]

  @@map("work_requests")
}

model Message {
  id        String      @id @default(cuid())
  content   String
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())

  // Relations
  sender      User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId    String
  receiver    User         @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  receiverId  String
  
  // Context - wiadomość może być związana z ogłoszeniem lub zleceniem
  jobOffer    JobOffer?    @relation(fields: [jobOfferId], references: [id], onDelete: Cascade)
  jobOfferId  String?
  workRequest WorkRequest? @relation(fields: [workRequestId], references: [id], onDelete: Cascade)
  workRequestId String?

  @@map("messages")
}

// ETAP 10 - SUBSCRIPTION & PAYMENT MODELS

model SubscriptionPlan {
  id          String   @id @default(cuid())
  name        String   @unique // "Basic", "Pro", "Enterprise"
  displayName String   // "Plan Podstawowy", "Plan Pro", "Plan Enterprise"
  description String?  // opis planu
  price       Float    // cena miesięczna w groszach (np. 2900 = 29.00 PLN)
  currency    String   @default("PLN")
  
  // Limity funkcjonalności
  maxCompanies      Int     @default(1)     // maksymalna liczba firm
  maxProjects       Int     @default(5)     // maksymalna liczba projektów
  maxWorkers        Int     @default(10)    // maksymalna liczba pracowników
  maxJobOffers      Int     @default(3)     // maksymalna liczba ogłoszeń o pracę
  maxWorkRequests   Int     @default(5)     // maksymalna liczba zleceń
  maxStorageGB      Float   @default(1.0)   // maksymalna przestrzeń dyskowa w GB
  
  // Funkcjonalności premium
  hasAdvancedReports Boolean @default(false) // zaawansowane raporty
  hasApiAccess      Boolean @default(false)  // dostęp do API
  hasPrioritySupport Boolean @default(false) // priorytetowe wsparcie
  hasCustomBranding Boolean @default(false)  // własny branding
  hasTeamManagement Boolean @default(false)  // zarządzanie zespołem
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                String             @id @default(cuid())
  status            SubscriptionStatus @default(TRIAL)
  
  // Daty subskrypcji
  startDate         DateTime           @default(now())
  endDate           DateTime?          // null dla aktywnych subskrypcji
  trialEndDate      DateTime?          // koniec okresu próbnego
  nextBillingDate   DateTime?          // następna data płatności
  
  // Płatności
  stripeCustomerId      String?        // ID klienta w Stripe
  stripeSubscriptionId  String?        // ID subskrypcji w Stripe
  stripePriceId         String?        // ID ceny w Stripe
  
  // Anulowanie
  cancelAtPeriodEnd Boolean            @default(false)
  canceledAt        DateTime?
  cancelReason      String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String             @unique // jeden user = jedna subskrypcja
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])
  planId            String
  payments          Payment[]

  @@map("subscriptions")
}

model Payment {
  id              String        @id @default(cuid())
  amount          Float         // kwota w groszach
  currency        String        @default("PLN")
  status          PaymentStatus @default(PENDING)
  
  // Stripe
  stripePaymentIntentId String?  // ID płatności w Stripe
  stripeInvoiceId       String?  // ID faktury w Stripe
  
  // Metadane
  description     String?       // opis płatności
  receiptUrl      String?       // link do paragonu
  invoiceUrl      String?       // link do faktury
  
  // Daty
  paidAt          DateTime?     // kiedy zapłacono
  failedAt        DateTime?     // kiedy płatność się nie powiodła
  refundedAt      DateTime?     // kiedy zwrócono pieniądze
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId  String

  @@map("payments")
}

// EXISTING ENUMS
enum Role {
  SUPERADMIN
  BOSS
  WORKER
}

enum WorkerStatus {
  INVITED
  ACTIVE
  INACTIVE
  LEFT
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ETAP 8 - NEW ENUMS

enum JobCategory {
  CONSTRUCTION_WORKER    // Robotnik budowlany
  ELECTRICIAN           // Elektryk
  PLUMBER              // Hydraulik
  PAINTER              // Malarz
  CARPENTER            // Stolarz
  MASON                // Murarz
  ROOFER               // Dekarz
  TILER                // Glazurnik
  FOREMAN              // Kierownik budowy
  ARCHITECT            // Architekt
  ENGINEER             // Inżynier
  HEAVY_EQUIPMENT      // Operator sprzętu
  LANDSCAPING          // Ogrodnictwo
  DEMOLITION           // Rozbiórki
  OTHER                // Inne
}

enum JobType {
  FULL_TIME            // Pełny etat
  PART_TIME            // Część etatu
  CONTRACT             // Kontrakt
  TEMPORARY            // Tymczasowa
  INTERNSHIP           // Staż
  FREELANCE            // Freelance
}

enum ExperienceLevel {
  JUNIOR               // Początkujący (0-2 lata)
  MID                  // Średniozaawansowany (2-5 lat)
  SENIOR               // Doświadczony (5+ lat)
  EXPERT               // Ekspert (10+ lat)
}

enum ApplicationStatus {
  PENDING              // Oczekująca
  REVIEWED             // Przejrzana
  ACCEPTED             // Zaakceptowana
  REJECTED             // Odrzucona
  WITHDRAWN            // Wycofana przez kandydata
}

enum WorkCategory {
  CONSTRUCTION         // Budowa
  RENOVATION           // Remont
  REPAIR               // Naprawa
  INSTALLATION         // Instalacja
  MAINTENANCE          // Konserwacja
  DEMOLITION           // Rozbiórka
  LANDSCAPING          // Ogrodnictwo
  CLEANING             // Sprzątanie
  PAINTING             // Malowanie
  ELECTRICAL           // Elektryka
  PLUMBING             // Hydraulika
  ROOFING              // Dekarstwo
  FLOORING             // Podłogi
  WINDOWS_DOORS        // Okna i drzwi
  OTHER                // Inne
}

enum RequestType {
  ONE_TIME             // Jednorazowe
  RECURRING            // Cykliczne
  PROJECT              // Projekt
  URGENT               // Pilne
}

// ETAP 10 - SUBSCRIPTION & PAYMENT ENUMS

enum SubscriptionStatus {
  TRIAL                // Okres próbny
  ACTIVE               // Aktywna
  PAST_DUE             // Zaległa płatność
  CANCELED             // Anulowana
  UNPAID               // Nieopłacona
  INCOMPLETE           // Niekompletna
  INCOMPLETE_EXPIRED   // Wygasła niekompletna
  PAUSED               // Wstrzymana
}

enum PaymentStatus {
  PENDING              // Oczekująca
  PROCESSING           // Przetwarzana
  SUCCEEDED            // Udana
  FAILED               // Nieudana
  CANCELED             // Anulowana
  REFUNDED             // Zwrócona
  PARTIALLY_REFUNDED   // Częściowo zwrócona
}

// ETAP 11 - NOTIFICATIONS MODEL
model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?            // dodatkowe dane (np. ID zadania, projektu)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED      // Przypisano zadanie
  TASK_COMPLETED     // Zadanie ukończone
  TASK_OVERDUE       // Zadanie przeterminowane
  PROJECT_CREATED    // Nowy projekt
  PROJECT_UPDATED    // Projekt zaktualizowany
  MESSAGE_RECEIVED   // Nowa wiadomość
  WORKER_INVITED     // Zaproszenie do firmy
  WORKER_JOINED      // Pracownik dołączył
  JOB_APPLICATION    // Nowa aplikacja o pracę
  MATERIAL_LOW       // Niski stan materiału
  SUBSCRIPTION_TRIAL_ENDING  // Koniec okresu próbnego
  SUBSCRIPTION_EXPIRED       // Subskrypcja wygasła
  PAYMENT_SUCCESS    // Płatność udana
  PAYMENT_FAILED     // Płatność nieudana
  SYSTEM_UPDATE      // Aktualizacja systemu
}

// ETAP 15 - ANALYTICS & REPORTING MODELS

model Analytics {
  id          String        @id @default(cuid())
  type        AnalyticsType
  data        Json          // dane analityczne w formacie JSON
  period      String        // daily, weekly, monthly, yearly
  startDate   DateTime      // początek okresu
  endDate     DateTime      // koniec okresu
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId   String

  @@map("analytics")
}

model Report {
  id          String     @id @default(cuid())
  name        String
  type        ReportType
  config      Json       // konfiguracja raportu (filtry, parametry)
  data        Json?      // wygenerowane dane raportu
  status      ReportStatus @default(PENDING)
  isScheduled Boolean    @default(false)
  schedule    String?    // cron expression dla automatycznych raportów
  filePath    String?    // ścieżka do wygenerowanego pliku
  fileFormat  String?    // PDF, EXCEL, CSV
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  generatedAt DateTime?  // kiedy raport został wygenerowany

  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId   String

  @@map("reports")
}

model Tag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#3B82F6") // domyślny niebieski
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId   String
  projects    Project[]
  tasks       Task[]
  materials   Material[]

  @@unique([name, companyId]) // unikalna nazwa tagu w firmie
  @@map("tags")
}

model SearchHistory {
  id        String   @id @default(cuid())
  query     String   // zapytanie wyszukiwania
  filters   Json?    // zastosowane filtry
  results   Int      @default(0) // liczba wyników
  category  String?  // kategoria wyszukiwania (projects, tasks, materials, etc.)
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@map("search_history")
}

model SavedSearch {
  id        String   @id @default(cuid())
  name      String   // nazwa zapisanego wyszukiwania
  query     String   // zapytanie wyszukiwania
  filters   Json?    // zastosowane filtry
  category  String?  // kategoria wyszukiwania
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@unique([userId, name]) // unikalna nazwa dla użytkownika
  @@map("saved_searches")
}

// ETAP 15 - NEW ENUMS

enum AnalyticsType {
  PROJECT_PROGRESS     // Postęp projektów
  COST_ANALYSIS       // Analiza kosztów
  TIME_TRACKING       // Śledzenie czasu
  TEAM_PERFORMANCE    // Wydajność zespołu
  TASK_METRICS        // Metryki zadań
  MATERIAL_USAGE      // Wykorzystanie materiałów
  FINANCIAL_OVERVIEW  // Przegląd finansowy
  PRODUCTIVITY_TRENDS // Trendy produktywności
}

enum ReportType {
  PROJECT_SUMMARY     // Podsumowanie projektu
  FINANCIAL_REPORT    // Raport finansowy
  TEAM_PRODUCTIVITY   // Produktywność zespołu
  TASK_COMPLETION     // Ukończenie zadań
  MATERIAL_INVENTORY  // Inwentarz materiałów
  TIME_TRACKING       // Śledzenie czasu
  COST_BREAKDOWN      // Podział kosztów
  CUSTOM_REPORT       // Raport niestandardowy
}

enum ReportStatus {
  PENDING             // Oczekujący
  GENERATING          // Generowanie
  COMPLETED           // Ukończony
  FAILED              // Nieudany
  SCHEDULED           // Zaplanowany
}
